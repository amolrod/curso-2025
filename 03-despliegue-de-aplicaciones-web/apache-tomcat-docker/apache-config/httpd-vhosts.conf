# ==============================================================================
# Configuración de Virtual Hosts para Apache HTTP Server
# ==============================================================================
# Propósito: Configurar Apache como reverse proxy hacia Tomcat usando AJP
# ==============================================================================

# Virtual Host en puerto 80 (HTTP)
<VirtualHost *:80>
    # Información del servidor
    ServerAdmin admin@example.com
    ServerName localhost
    ServerAlias www.localhost
    
    # Directorio raíz para contenido estático (opcional)
    DocumentRoot "/usr/local/apache2/htdocs"
    
    # Configuración de directorios
    <Directory "/usr/local/apache2/htdocs">
        Options Indexes FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>

    # ==============================================================================
    # CONFIGURACIÓN DE PROXY HACIA TOMCAT
    # ==============================================================================
    
    # Habilitar el motor de proxy
    ProxyRequests Off
    ProxyPreserveHost On
    
    # Configuración de timeout para evitar errores en aplicaciones lentas
    ProxyTimeout 300
    
    # Aumentar el tamaño máximo de paquete AJP para evitar errores
    # Por defecto es 8192, lo aumentamos a 65536
    ProxyIOBufferSize 65536
    
    # ==============================================================================
    # PROXY PARA APLICACIONES WAR
    # ==============================================================================
    # Redirigir todas las peticiones a /app/* hacia Tomcat vía AJP
    # Formato: ProxyPass <ruta-local> <protocolo>://<host>:<puerto>/<ruta-remota>
    
    # Ejemplo 1: Proxy para aplicación demo (ajustar según tu archivo WAR)
    ProxyPass /demo ajp://tomcat:8009/demo
    ProxyPassReverse /demo ajp://tomcat:8009/demo
    
    # Ejemplo 2: Proxy para aplicación Formulario
    ProxyPass /Formulario ajp://tomcat:8009/Formulario
    ProxyPassReverse /Formulario ajp://tomcat:8009/Formulario
    
    # Ejemplo 3: Proxy para la raíz de Tomcat
    ProxyPass /tomcat ajp://tomcat:8009/
    ProxyPassReverse /tomcat ajp://tomcat:8009/
    
    # Ejemplo 4: Proxy para Tomcat Manager (interfaz administrativa)
    # IMPORTANTE: Solo para desarrollo, en producción usar autenticación adicional
    <Location /manager>
        ProxyPass ajp://tomcat:8009/manager
        ProxyPassReverse ajp://tomcat:8009/manager
        # Permitir autenticación HTTP Basic hacia Tomcat
        Order allow,deny
        Allow from all
    </Location>
    
    # Proxy para Host Manager
    <Location /host-manager>
        ProxyPass ajp://tomcat:8009/host-manager
        ProxyPassReverse ajp://tomcat:8009/host-manager
        Order allow,deny
        Allow from all
    </Location>
    
    # ==============================================================================
    # CONFIGURACIÓN DE BALANCEO DE CARGA (OPCIONAL)
    # ==============================================================================
    # Descomenta y configura si tienes múltiples instancias de Tomcat
    #
    # <Proxy balancer://tomcat-cluster>
    #     BalancerMember ajp://tomcat1:8009 route=tomcat1
    #     BalancerMember ajp://tomcat2:8009 route=tomcat2
    #     ProxySet lbmethod=byrequests
    # </Proxy>
    #
    # ProxyPass /app balancer://tomcat-cluster/app
    # ProxyPassReverse /app balancer://tomcat-cluster/app
    
    # ==============================================================================
    # REGLAS DE REESCRITURA (OPCIONAL)
    # ==============================================================================
    # Útil para redirigir peticiones o modificar URLs
    
    # Habilitar motor de reescritura
    RewriteEngine On
    
    # Ejemplo: Redirigir la raíz a /demo
    # RewriteRule ^/$ /demo [R=301,L]
    
    # ==============================================================================
    # SEGURIDAD
    # ==============================================================================
    
    # Evitar que Apache sirva archivos .war, .jar directamente
    <FilesMatch "\.(war|jar|class)$">
        Require all denied
    </FilesMatch>
    
    # Ocultar información de versión del servidor
    ServerSignature Off
    
    # ==============================================================================
    # CONFIGURACIÓN DE LOGS
    # ==============================================================================
    
    # Log de errores
    ErrorLog /usr/local/apache2/logs/error.log
    
    # Log de acceso con formato combinado (incluye más información)
    CustomLog /usr/local/apache2/logs/access.log combined
    
    # Log específico para peticiones proxy (útil para debugging)
    CustomLog /usr/local/apache2/logs/proxy.log combined env=proxy
    
    # Nivel de logging (opciones: debug, info, notice, warn, error, crit, alert, emerg)
    LogLevel warn
    
    # Para debugging de mod_proxy, cambiar a:
    # LogLevel warn proxy:trace2 proxy_ajp:trace2

</VirtualHost>

# ==============================================================================
# NOTAS IMPORTANTES
# ==============================================================================
#
# 1. PROTOCOLO AJP:
#    - AJP (Apache JServ Protocol) es más eficiente que HTTP para comunicación
#      entre Apache y Tomcat
#    - El puerto por defecto de AJP en Tomcat es 8009
#    - En Docker Compose, 'tomcat' es el nombre del servicio/hostname
#
# 2. ProxyPass vs ProxyPassReverse:
#    - ProxyPass: Redirige peticiones del cliente al backend
#    - ProxyPassReverse: Ajusta las cabeceras de respuesta del backend
#    - Siempre usar ambos para evitar problemas con redirects
#
# 3. SEGURIDAD:
#    - En producción, proteger /manager con autenticación adicional
#    - Considerar usar HTTPS (puerto 443) con certificados SSL/TLS
#    - Implementar reglas de firewall y limitación de rate
#
# 4. RENDIMIENTO:
#    - Ajustar ProxyTimeout según necesidades de tu aplicación
#    - Considerar habilitar mod_cache para contenido estático
#    - Usar KeepAlive para conexiones persistentes
#
# ==============================================================================
